<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crypto Price Prediction</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="container">
        <h1 class="text-center">Crypto Price Prediction</h1>
        <table class="table table-dark table-striped table-bordered">
            <thead>
                <tr>
                    <th>Rank</th>
                    <th>Nome</th>
                    <th>Símbolo</th>
                    <th>Preço</th>
                    <th>Volume (24h)</th>
                    <th>Capitalização de Mercado</th>
                    <th>Alteração (24h)</th>
                    <th>Ação</th>
                    <th>Resultado da Previsão</th>
                </tr>
            </thead>
            <tbody>
                {% for crypto in crypto_data %}
                <tr>
                    <td>{{ crypto.cmc_rank }}</td>
                    <td>{{ crypto.name }}</td>
                    <td>{{ crypto.symbol }}</td>
                    <td>${{ crypto.quote.USD.price | round(2) }}</td>
                    <td>${{ crypto.quote.USD.volume_24h | round(2) }}</td>
                    <td>${{ crypto.quote.USD.market_cap | round(2) }}</td>
                    <td>{{ crypto.quote.USD.percent_change_24h | round(2) }}%</td>
                    <td>
                        <button class="btn btn-primary predict-price" data-symbol="{{ crypto.symbol }}">Prever Preço</button>
                    </td>
                    <td>
                        <div id="prediction-result-{{ crypto.symbol }}"></div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>

        <h2 class="text-center mt-5">Análise de Sentimento das Notícias</h2>
        <div class="progress mx-auto" style="width: 50%;">
            <div class="progress-bar bg-info" role="progressbar" style="width: {{ sentiment * 100 }}%" aria-valuenow="{{ sentiment * 100 }}" aria-valuemin="0" aria-valuemax="100">
                {{ sentiment | round(2) }}
            </div>
        </div>

        <h3 class="text-center mt-5">Principais Notícias</h3>
        <div id="news-articles">
            {% for article in news %}
                <div class="card">
                    <div class="card-body">
                        <a href="{{ article.url }}" class="news-title" target="_blank">{{ article.title }}</a>
                        <p class="news-description">{{ article.description }}</p>
                    </div>
                </div>
            {% endfor %}
        </div>

        <h3 class="text-center mt-5">Lista de Previsões</h3>
        <ul id="prediction-list" class="list-group mt-3"></ul>
    </div>
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        $(document).ready(function() {
            $('.predict-price').on('click', function() {
                const symbol = $(this).data('symbol');
                console.log(`Fetching prices for: ${symbol}`);
                $.ajax({
                    url: `/fetch-prices/${symbol}`,
                    method: 'GET',
                    success: function(response) {
                        console.log(`Fetched prices for ${symbol}:`, response);
                        if (response.prices) {
                            const prices = response.prices;
                            $.ajax({
                                url: '/predict',
                                method: 'POST',
                                contentType: 'application/json',
                                data: JSON.stringify({prices: prices}),
                                success: function(response) {
                                    console.log(`Prediction result for ${symbol}:`, response);
                                    const result = response.predicted_price.toFixed(2);
                                    $('#prediction-result-' + symbol).html('<h4>Preço Previsto: $' + result + '</h4>');
                                    $('#prediction-list').append('<li class="list-group-item">Previsão para ' + symbol + ': $' + result + '</li>');
                                },
                                error: function(error) {
                                    console.error(`Error predicting price for ${symbol}:`, error);
                                }
                            });
                        } else {
                            $('#prediction-result-' + symbol).html('<h4 class="text-danger">Erro ao obter preços</h4>');
                        }
                    },
                    error: function(error) {
                        console.error(`Error fetching prices for ${symbol}:`, error);
                        $('#prediction-result-' + symbol).html('<h4 class="text-danger">Erro ao obter preços</h4>');
                    }
                });
            });
        });
    </script>
</body>
</html>
